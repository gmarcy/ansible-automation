#!/bin/env bash
set -eux

# MCD="quay.io/openshift/origin-machine-config-operator:4.10"
# while ! podman pull --quiet "${MCD}"
# do
#     echo "Pull failed. Retrying ${MCD}..."
#     sleep 5
# done
# mnt=$(podman image mount "${MCD}")
# Extract machine-config-daemon binary
# cp -rvf ${mnt}/usr/bin/machine-config-daemon /usr/local/bin/machine-config-daemon
# chmod a+x /usr/local/bin/machine-config-daemon
# restorecon -Rv /usr/local/bin/machine-config-daemon
# podman rmi -f "${MCD}"

RPMS="registry.ci.openshift.org/origin/4.10:artifacts"
while ! podman pull --quiet "${RPMS}"
do
    echo "Pull failed. Retrying ${RPMS}..."
    sleep 5
done
mnt=$(podman image mount "${RPMS}")
# Install RPMs in overlayed FS
mkdir /tmp/rpms
curl -o /tmp/rpms/crio.rpm -L {{ crio_rpm_url }}
curl -o /tmp/rpms/cri-tools.rpm -L {{ cri_tools_rpm_url }}
cp -rvf ${mnt}/srv/repo/*.rpm /tmp/rpms
tmpd=$(mktemp -d)
mkdir ${tmpd}/{upper,work}
mount -t overlay -o lowerdir=/usr,upperdir=${tmpd}/upper,workdir=${tmpd}/work overlay /usr
rpm -Uvh /tmp/rpms/*
podman rmi -f "${RPMS}"

# Expand /var to 6G if necessary
if (( $(stat -c%s /run/ephemeral.xfsloop) > 6*1024*1024*1024 )); then
  exit 0
fi
/bin/truncate -s 6G /run/ephemeral.xfsloop
losetup -c /dev/loop0
xfs_growfs /var
mount -o remount,size=6G /run
