---

- name: Set facts for cluster
  set_fact:
    console_username: "{{ kubeadmin_username }}"
    console_password: "{{ kubeadmin_password }}"
  no_log: false

- name: Set fact for cluster API url
  set_fact:
    cluster_api_url: "{{ 'https://' + ocp_api_url + ':' + ocp_api_port }}"

- name: Authenticate to the cluster
  community.okd.openshift_auth:
    host: "{{ cluster_api_url }}"
    username: "{{ console_username }}"
    password: "{{ console_password }}"
    state: present
    validate_certs: false
  register: _result
  no_log: false
  until: not _result.failed

- name: Set facts for cluster
  set_fact:
    api_key: "{{ _result.openshift_auth.api_key }}"
  no_log: false

- name: Set cluster_facts
  set_fact:
    api_key: "{{ hostvars[inventory_hostname]['api_key'] }}"
  delegate_to: 'cluster-facts'
  delegate_facts: true
