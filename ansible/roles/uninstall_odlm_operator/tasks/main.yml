---

- name: Fetch Subscription for IBM ODLM
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    kubeconfig: "{{ kubeconfig_path }}"
    name: operand-deployment-lifecycle-manager-app
    namespace: "{{ target_namespace }}"
  register: _result

- name: Set fact for installedCSV
  set_fact:
    installed_csv: "{{ item.status.installedCSV }}"
  loop: "{{ _result.resources }}"
  when: item.status.installedCSV | default('') | length > 0

- name: Remove Subscription for IBM ODLM
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    kubeconfig: "{{ kubeconfig_path }}"
    name: operand-deployment-lifecycle-manager-app
    namespace: "{{ target_namespace }}"
    state: absent
    wait: true
  register: _result

- name: Remove installed_csv if defined
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    kubeconfig: "{{ kubeconfig_path }}"
    name: "{{ installed_csv }}"
    namespace: "{{ target_namespace }}"
    state: absent
    wait: true
  register: _result
  when: installed_csv | default('') | length > 0

- when: uninstall_operators_completely | default(false) | bool
  block:

    - name: Fetch Operator CRD for this operator
      kubernetes.core.k8s_info:
        api_key: "{{ api_key | default(omit) }}"
        api_version: operators.coreos.com/v1
        kind: Operator
        kubeconfig: "{{ kubeconfig_path }}"
        name: "ibm-odlm.{{ target_namespace }}"
      register: _result

    - name: Collect all the component refs
      set_fact:
        component_refs: "{{ item.status.components.refs }}"
      loop: "{{ _result.resources }}"
      when: item.status.components.refs | default([]) | length > 0

    - name: Remove all the components we are referencing
      kubernetes.core.k8s:
        api_key: "{{ api_key | default(omit) }}"
        api_version: "{{ item.apiVersion }}"
        kind: "{{ item.kind }}"
        kubeconfig: "{{ kubeconfig_path }}"
        name: "{{ item.name }}"
        namespace: "{{ item.namespace | default(omit) }}"
        state: absent
        wait: true
      register: _result
      loop: "{{ component_refs | default([]) }}"

    - name: Remove Operator CRD
      kubernetes.core.k8s:
        api_key: "{{ api_key | default(omit) }}"
        api_version: operators.coreos.com/v1
        kind: Operator
        kubeconfig: "{{ kubeconfig_path }}"
        name: "ibm-odlm.{{ target_namespace }}"
        state: absent
        wait: true
      register: _result
