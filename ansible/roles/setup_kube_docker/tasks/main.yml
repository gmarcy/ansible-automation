---

- name: Check marker file for this play
  stat:
    path: kube_docker_setup
  register: _result_stat

- block:

    - name: Install the repository
      copy:
        content: |
          [kubernetes]
          name=Kubernetes
          baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
          enabled=1
          gpgcheck=0
          repo_gpgcheck=1
          gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        dest: /etc/yum.repos.d/kubernetes.repo
        mode: 0644
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Install kubernetes and docker
      package:
        name:
          - "{{ 'kubelet-' + kubernetes_version }}"
          - "{{ 'kubeadm-' + kubernetes_version }}"
          - "{{ 'kubectl-' + kubernetes_version }}"
          - kubernetes-cni-0.8.7-0.x86_64
        state: present
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Install yum-utils
      package:
        name: yum-utils
        state: present
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Run yum-config-manager to add the docker-ce repo
      command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Run yum makecache
      command: yum makecache
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Install docker-ce
      dnf:
        name: docker-ce
        allowerasing: true
      when: hostvars[inventory_hostname].distribution_family == 'CentOS'

    - name: Update packages
      apt:
        name: docker.io
        state: present
      when: hostvars[inventory_hostname].distribution_family == 'Debian'

    - name: Add the gpg key for google cloud packages
      shell: |
        curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add
        apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"
      args:
        executable: /bin/bash
      register: _result
      changed_when: _result is not defined
      when: hostvars[inventory_hostname].distribution_family == 'Debian'

    - name: Install kubelet, kubeadm, and kubectl
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
      when: hostvars[inventory_hostname].distribution_family == 'Debian'

    - name: Install specific versions of kubadm, kubelet, and kubectl
      apt:
        name:
          - "{{ 'kubelet=' + kubernetes_version + '-00' }}"
          - "{{ 'kubeadm=' + kubernetes_version + '-00' }}"
          - "{{ 'kubectl=' + kubernetes_version + '-00' }}"
        allow_downgrades: true
        # allow_change_held_packages: true
      when: hostvars[inventory_hostname].distribution_family == 'Debian'

    - name: Enable and restart docker service
      systemd:
        name: docker
        state: restarted
        enabled: true
      changed_when: false

    - name: Enable and restart kubelet service
      systemd:
        name: kubelet
        state: restarted
        enabled: true
      changed_when: false

    - name: Touch file to indicate we have completed kube docker setup
      file:
        path: kube_docker_setup
        state: touch
      changed_when: false

  when: not _result_stat.stat.exists
