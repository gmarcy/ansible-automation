---

- name: Set facts for cephfs install
  set_fact:
    rookRelease: "{{ rook_cephfs_release }}"
    device_filter: "{{ device_name }}"
    new_default_sc: "{{ default_sc }}"

- name: Check if the new storage class exists
  kubernetes.core.k8s_info:
    api_key: "{{ api_key }}"
    api_version: storage.k8s.io/v1
    kind: StorageClass
    kubeconfig: "{{ kubeconfig_path }}"
    name: "{{ new_default_sc }}"
  register: _result_sc

- name: Set fact if storage class is present and the default
  set_fact:
    cephfs_storage_ready: true
  loop: "{{ _result_sc.resources | map(attribute='metadata.annotations') }}"
  when: item['storageclass.kubernetes.io/is-default-class'] == 'true'

- name: Check if CephCluster exists
  kubernetes.core.k8s_info:
    api_key: "{{ api_key }}"
    api_version: ceph.rook.io/v1
    kind: CephCluster
    kubeconfig: "{{ kubeconfig_path }}"
    name: rook-ceph
    namespace: rook-ceph
  register: _result_cephcluster
  when: cephfs_storage_ready | default(false)

- name: Set fact if CephFS is Ready
  set_fact:
    cephfs_is_ready: "{{ (_result_cephcluster.resources | length > 0) and (_result_cephcluster.resources | map(attribute='status.phase') | difference(['Ready']) | length == 0) }}"
  when: cephfs_storage_ready | default(false)

- when: not ((cephfs_storage_ready | default(false)) and (cephfs_is_ready | default(false)))
  name: Install CephFS
  block:
    # BLOCK_START

    - name: Create setup directory
      file:
        path: "{{ cephfs_bastion_setup_dir }}"
        state: "{{ item }}"
        mode: '0755'
      with_items:
      - directory

    # Install ceph

    - name: Set rook_setup_dir fact
      set_fact:
        rook_setup_dir: "{{ cephfs_bastion_setup_dir }}/rook"

    - name: Remove any previous clone of the rook git repo
      file:
        path: "{{ rook_setup_dir }}"
        state: "{{ item }}"
      loop:
      - absent
      - directory

    - name: Clone the rook master or release-major.minor branch
      git:
        repo: http://github.com/rook/rook.git
        dest: "{{ cephfs_bastion_setup_dir }}/rook"
        version: "{{ 'master' if rookRelease == 'master' else 'release-' + (rookRelease | regex_replace('v([0-9]+\\.[0-9]+)\\..*', '\\1')) }}"

    - name: Clone the rook HEAD or rookRelease tag
      git:
        repo: http://github.com/rook/rook.git
        dest: "{{ cephfs_bastion_setup_dir }}/rook"
        version: "{{ 'HEAD' if rookRelease == 'master' else rookRelease }}"

    - name: Set majorRelease fact
      set_fact:
        majorRelease: "{{ rookRelease | regex_replace('(v[0-9]+\\.[0-9]+)\\..*', '\\1') }}"

    - name: Set path for examples within rook repo
      set_fact:
        rookPath: "{{ rook_setup_dir + ('/cluster/examples/kubernetes/ceph' if (majorRelease | regex_replace('v[0-9]+\\.([0-9]+)\\..*', '\\1') | int >= 8) else '/deploy/examples') }}"

    - name: Ensure namespace exists
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kind: Namespace
        kubeconfig: "{{ kubeconfig_path }}"
        name: rook-ceph
        state: present
      register: _result

    - name: Disable bluefs_buffered_io
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        definition:
          data:
            config: |
              [global]
              bluefs_buffered_io = false
        kind: ConfigMap
        kubeconfig: "{{ kubeconfig_path }}"
        name: rook-config-override
        namespace: rook-ceph
      register: _result

    - name: Apply crds.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/crds.yaml' }}"
      register: _result
      when: majorRelease != 'v1.4'

    - name: Apply common.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/common.yaml' }}"
      register: _result

    - name: Apply operator-openshift.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/operator-openshift.yaml' }}"
      register: _result

    - name: Wait for ceph operator to be Running
      kubernetes.core.k8s_info:
        api_key: "{{ api_key }}"
        kind: Pod
        kubeconfig: "{{ kubeconfig_path }}"
        label_selectors:
        - app=rook-ceph-operator
        namespace: rook-ceph
        wait: true
        wait_condition:
          type: Ready
      register: _result

    - name: Set useAllDevices to false
      blockinfile:
        path: "{{ rookPath + '/cluster.yaml' }}"
        marker: '    # {mark} PATCH'
        block: |
          # disable useAllDevices, add deviceFilter
              useAllDevices: false
              deviceFilter: "{{ device_filter | default('^vd[b-z]$') }}"
        insertafter: '^    useAllDevices: true$'

    - name: Remove the original useAllDevices true
      lineinfile:
        path: "{{ rookPath + '/cluster.yaml' }}"
        regexp: '^    useAllDevices: true$'
        state: absent

    - name: Apply cluster.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/cluster.yaml' }}"
      register: _result

    - name: Wait for all rook-ceph-osd pods to be Running
      kubernetes.core.k8s_info:
        api_key: "{{ api_key }}"
        kind: Pod
        kubeconfig: "{{ kubeconfig_path }}"
        label_selectors:
        - app=rook-ceph-osd
        namespace: rook-ceph
      register: _result
      delay: 20
      retries: 30
      until: (_result.resources | length >= 3) and (_result.resources | map(attribute='status.phase') | unique | difference(['Running']) | length == 0)

    - name: Apply filesystem-test.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/filesystem-test.yaml' }}"
      register: _result

    - name: Apply csi/cephfs/storageclass.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/csi/cephfs/storageclass.yaml' }}"
      register: _result

    - name: Replace the metadata name rook-cephfs with csi-cephfs in storageclass.yaml
      lineinfile:
        path: "{{ rookPath + '/csi/cephfs/storageclass.yaml' }}"
        regexp: '^  name: rook-cephfs$'
        line: '    name: csi-cephfs'

    - name: Apply csi/cephfs/storageclass.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/csi/cephfs/storageclass.yaml' }}"
      register: _result

    - name: Check for existing default storage class
      kubernetes.core.k8s_info:
        api_key: "{{ api_key }}"
        api_version: storage.k8s.io/v1
        kind: StorageClass
        kubeconfig: "{{ kubeconfig_path }}"
      register: _result

    - name: Set fact for existing default storage class
      set_fact:
        old_default_sc: "{{ item.metadata.name }}"
      loop: "{{ _result.resources }}"
      when: item['metadata']['annotations']['storageclass.kubernetes.io/is-default-class'] | default('false') | bool

    - name: Clear the old default storage class
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        api_version: storage.k8s.io/v1
        definition:
          metadata:
            annotations:
              storageclass.kubernetes.io/is-default-class: 'false'
        kind: StorageClass
        kubeconfig: "{{ kubeconfig_path }}"
        name: "{{ old_default_sc }}"
        state: patched
      register: _result
      when: old_default_sc is defined

    - name: Set the default storage class
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        api_version: storage.k8s.io/v1
        definition:
          metadata:
            annotations:
              storageclass.kubernetes.io/is-default-class: 'true'
        kind: StorageClass
        kubeconfig: "{{ kubeconfig_path }}"
        name: "{{ new_default_sc }}"
        state: patched
      register: _result

    - name: Apply csi/rbd/storageclass-test.yaml to the cluster
      kubernetes.core.k8s:
        api_key: "{{ api_key }}"
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rookPath + '/csi/rbd/storageclass-test.yaml' }}"
      register: _result

    - name: Wait for all rook-ceph-mds pods to be Running
      kubernetes.core.k8s_info:
        api_key: "{{ api_key }}"
        kind: Pod
        kubeconfig: "{{ kubeconfig_path }}"
        label_selectors:
        - app=rook-ceph-mds
        namespace: rook-ceph
      register: _result
      delay: 20
      retries: 30
      until: (_result.resources | length > 0) and (_result.resources | map(attribute='status.phase') | unique | difference(['Running']) | length == 0)

    - name: Wait until CephCluster is Ready
      kubernetes.core.k8s_info:
        api_key: "{{ api_key }}"
        api_version: ceph.rook.io/v1
        kind: CephCluster
        kubeconfig: "{{ kubeconfig_path }}"
        name: rook-ceph
        namespace: rook-ceph
      register: _result
      delay: 20
      retries: 30
      until: (_result.resources | length > 0) and (_result.resources | map(attribute='status.phase') | unique | difference(['Ready']) | length == 0)

  # BLOCK_END
