---

- name: Fetch cluster credentials
  uri:
    url: "{{ cluster_url }}/credentials"
  register: _result
  no_log: "{{ noLog }}"

- name: Set facts for cluster
  set_fact:
    console_username: "{{ _result.json.username }}"
    console_password: "{{ _result.json.password }}"
    console_url: "{{ _result.json.console_url }}"
  no_log: "{{ noLog }}"

- name: Authenticate to the cluster
  community.okd.openshift_auth:
    host: "{{ cluster_api_url }}"
    username: "{{ console_username }}"
    password: "{{ console_password }}"
    state: present
    validate_certs: false
  register: _result
  no_log: "{{ noLog }}"

- name: Set facts for cluster
  set_fact:
    api_key: "{{ _result.openshift_auth.api_key }}"
  no_log: "{{ noLog }}"

- name: Set cluster_facts
  set_fact:
    api_key: "{{ hostvars[inventory_hostname]['api_key'] }}"
  no_log: "{{ noLog }}"
  delegate_to: 'cluster-facts'
  delegate_facts: true
