---

- name: Get current deployment info
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Deployment
    name: "{{ target_operator }}"
    namespace: "{{ target_namespace }}"
  register: _result_initial_state

- name: Add argument to deployment
  kubernetes.core.k8s_json_patch:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Deployment
    name: "{{ target_operator }}"
    namespace: "{{ target_namespace }}"
    patch:
    - op: add
      path: '/spec/template/spec/containers/0/args/-'
      value: "{{ target_argument }}"
  register: _result

- name: Get current deployment info
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Deployment
    name: "{{ target_operator }}"
    namespace: "{{ target_namespace }}"
  register: _result
  until: >
    (_result.resources[0].status.replicas == _result_initial_state.resources[0].status.replicas) and
    (_result.resources[0].status.unavailableReplicas is not defined)
