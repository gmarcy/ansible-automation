---

- name: Fetch Subscription for IBM Namespace Scope Operator
  kubernetes.core.k8s_info:
    api_key: "{{ api_key }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    kubeconfig: "{{ kubeconfig_path }}"
    name: ibm-namespace-scope-operator
    namespace: "{{ target_namespace }}"
  register: _result

- name: Remove any CSVs mentioned in the Subscription
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    kubeconfig: "{{ kubeconfig_path }}"
    name: "{{ item.status.installedCSV }}"
    namespace: "{{ target_namespace }}"
    state: absent
    wait: true
  loop: "{{ _result.resources }}"
  when: item.status.installedCSV | default('') | length > 0
  register: _result

- name: Remove Subscription for IBM Namespace Scope Operator
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    kubeconfig: "{{ kubeconfig_path }}"
    name: ibm-namespace-scope-operator
    namespace: "{{ target_namespace }}"
    state: absent
    wait: true
  register: _result
