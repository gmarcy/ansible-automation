---

- name: Check for existing CatalogSource
  kubernetes.core.k8s_info:
    api_key: "{{ api_key }}"
    api_version: operators.coreos.com/v1alpha1
    kind: CatalogSource
    kubeconfig: "{{ kubeconfig_path }}"
    name: ibm-operator-catalog
    namespace: openshift-marketplace
  register: _result

- name: Set fact for IBM Operator CatalogSource
  set_fact:
    ibm_operator_catalog_installed: "{{ _result.resources | length > 0 }}"

- name: Create IBM Operator CatalogSource
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: operators.coreos.com/v1alpha1
    kind: CatalogSource
    kubeconfig: "{{ kubeconfig_path }}"
    name: ibm-operator-catalog
    namespace: openshift-marketplace
    definition:
      spec:
        displayName: IBM Operator Catalog
        image: icr.io/cpopen/ibm-operator-catalog
        publisher: IBM
        sourceType: grpc
        updateStrategy:
          registryPoll:
            interval: 45m
  register: _result
  delay: 20
  retries: 30
  until: _result.result.status is defined and (_result.result.status.connectionState.lastObservedState == 'READY')
  when: not ibm_operator_catalog_installed
