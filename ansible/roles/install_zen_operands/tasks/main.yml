---

- name: Create ZenService instance
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    api_version: zen.cpd.ibm.com/v1
    kind: ZenService
    kubeconfig: "{{ kubeconfig_path }}"
    name: websphereauto
    namespace: "{{ target_namespace }}"
    definition:
      spec:
        csNamespace: "{{ registry_namespace }}"
        iamIntegration: true
        scaleConfig: small
        storageClass: "{{ zen_storage_class }}"
        fileStorageClass: "{{ zen_storage_class }}"
        blockStorageClass: "{{ zen_block_class }}"
    wait: "{{ wait_for_zenservice_success | default(true) }}"
    wait_condition:
      type: Successful
    wait_sleep: 60
    wait_timeout: 2400
  register: _result

- name: Wait for ZenService to reach zenStatus of Completed
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    api_version: zen.cpd.ibm.com/v1
    kind: ZenService
    kubeconfig: "{{ kubeconfig_path }}"
    name: websphereauto
    namespace: "{{ target_namespace }}"
  register: _result
  delay: 30
  retries: 120
  until: (_result.resources | length > 0) and (_result.resources | map(attribute='status.zenStatus') | unique == ['Completed'])
  when: wait_for_zenstatus_completed | default(true)
