---

- name: Create the events OperandRequest
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: operator.ibm.com/v1alpha1
    kind: OperandRequest
    kubeconfig: "{{ kubeconfig_path }}"
    name: operand-request-events
    namespace: "{{ target_namespace }}"
    definition:
      metadata:
        labels:
          ibm-common-services.common-service/config: 'true'
          ibm-common-services.common-service/registry: 'true'
          operator.ibm.com/opreq-control: 'true'
      spec:
        requests:
        - operands:
          - name: ibm-events-operator
          registry: common-service
          registryNamespace: "{{ registry_namespace }}"
    wait: true
    wait_condition:
      type: Ready
    wait_sleep: 20
    wait_timeout: 300
  register: _result

- name: Create Kafka instance
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: ibmevents.ibm.com/v1beta2
    kind: Kafka
    kubeconfig: "{{ kubeconfig_path }}"
    name: iaf-system
    namespace: "{{ target_namespace }}"
    definition:
      metadata:
        labels:
          app.kubernetes.io/name: ibm-events-operator
          app.kubernetes.io/managed-by: ibm-events-operator
          app.kubernetes.io/instance: ibm-events-operator
      spec:
        # clusterCa:
        #   generateCertificateAuthority: false
        kafka:
          replicas: 1
          listeners:
            - name: tls
              port: 9093
              type: internal
              tls: true
              authentication:
                type: scram-sha-512
            - name: external
              port: 9094
              type: route
              tls: true
              authentication:
                type: scram-sha-512
          config:
            offsets.topic.replication.factor: 1
            transaction.state.log.replication.factor: 1
            transaction.state.log.min.isr: 1
          template:
            pod:
              metadata:
                annotations:
                  productName: IBM Cloud Platform Common Services
                  productID: 068a62892a1e4db39641342e592daa25
                  productMetric: FREE
              securityContext:
                runAsNonRoot: true
              # tmpDirSizeLimit: 20Mi
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                          - key: kubernetes.io/arch
                            operator: In
                            values:
                              - amd64
                              - s390x
                              - ppc64le
                # podAntiAffinity:
                #   preferredDuringSchedulingIgnoredDuringExecution:
                #     - podAffinityTerm:
                #         labelSelector:
                #           matchExpressions:
                #             - key: ibmevents.ibm.com/name
                #               operator: In
                #               values:
                #                 - iaf-system-kafka
                #         topologyKey: kubernetes.io/hostname
                #       weight: 100
            kafkaContainer:
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
          storage:
            type: persistent-claim
            size: 10Gi
            class: rook-ceph-block
          authorization:
            type: simple
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
        zookeeper:
          replicas: 1
          template:
            pod:
              metadata:
                annotations:
                  productName: IBM Cloud Platform Common Services
                  productID: 068a62892a1e4db39641342e592daa25
                  productMetric: FREE
              securityContext:
                runAsNonRoot: true
              # tmpDirSizeLimit: 20Mi
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                          - key: kubernetes.io/arch
                            operator: In
                            values:
                              - amd64
                              - s390x
                              - ppc64le
                # podAntiAffinity:
                #   preferredDuringSchedulingIgnoredDuringExecution:
                #     - podAffinityTerm:
                #         labelSelector:
                #           matchExpressions:
                #             - key: ibmevents.ibm.com/name
                #               operator: In
                #               values:
                #                 - iaf-system-kafka
                #         topologyKey: kubernetes.io/hostname
                #       weight: 100
            zookeeperContainer:
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
          storage:
            type: persistent-claim
            size: 2Gi
            class: rook-ceph-block
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
        entityOperator:
          template:
            pod:
              metadata:
                annotations:
                  productName: IBM Cloud Platform Common Services
                  productID: 068a62892a1e4db39641342e592daa25
                  productMetric: FREE
              securityContext:
                runAsNonRoot: true
              # tmpDirSizeLimit: 20Mi
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                          - key: kubernetes.io/arch
                            operator: In
                            values:
                              - amd64
                              - s390x
                              - ppc64le
                # podAntiAffinity:
                #   preferredDuringSchedulingIgnoredDuringExecution:
                #   - podAffinityTerm:
                #       labelSelector:
                #         matchExpressions:
                #         - key: ibmevents.ibm.com/name
                #           operator: In
                #           values:
                #           - iaf-system-kafka
                #       topologyKey: kubernetes.io/hostname
                #     weight: 100
            topicOperatorContainer:
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
            userOperatorContainer:
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
            tlsSidecarContainer:
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                privileged: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
          tlsSidecar:
            resources:
              requests:
                cpu: 500m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 128Mi
          userOperator:
            resources:
              requests:
                cpu: 1
                memory: 1Gi
              limits:
                cpu: 1
                memory: 1Gi
          topicOperator:
            resources:
              requests:
                cpu: 1
                memory: 1Gi
              limits:
                cpu: 1
                memory: 1Gi
    wait: true
    wait_condition:
      type: Ready
    wait_sleep: 60
    wait_timeout: 1500
  register: _result

- name: Create KafkaUser instance
  kubernetes.core.k8s:
    api_key: "{{ api_key }}"
    api_version: ibmevents.ibm.com/v1beta2
    kind: KafkaUser
    kubeconfig: "{{ kubeconfig_path }}"
    name: websphereauto-kafka-auth
    namespace: "{{ target_namespace }}"
    definition:
      metadata:
        labels:
          ibmevents.ibm.com/cluster: iaf-system
      spec:
        authentication:
          type: scram-sha-512
        authorization:
          type: simple
          acls:
          - resource:
              type: topic
              name: websphereauto
              patternType: prefix
            operation: All
            host: '*'
          - resource:
              type: group
              name: websphereauto
              patternType: prefix
            operation: All
            host: '*'
          - resource:
              type: topic
              name: __schema_websphereauto
              patternType: prefix
            operation: Read
            host: '*'
          - resource:
              type: topic
              name: __schema_websphereauto
              patternType: prefix
            operation: Alter
            host: '*'
          - resource:
              type: cluster
            operation: Describe
            host: '*'
          - resource:
              type: topic
              name: __schema_
              patternType: prefix
            operation: Read
            host: '*'
    wait: true
    wait_condition:
      type: Ready
    wait_sleep: 20
    wait_timeout: 300
  register: _result
