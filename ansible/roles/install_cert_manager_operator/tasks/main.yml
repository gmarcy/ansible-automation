---

- name: Create Subscription for Community Cert Manager
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: cert-manager
    namespace: "{{ operators_namespace }}"
    definition:
      metadata:
        labels: "{{ labels }}"
      spec:
        channel: stable
        installPlanApproval: Automatic
        name: cert-manager
        source: "{{ community_operators_source }}"
        sourceNamespace: "{{ community_operators_source_namespace }}"
        startingCSV: cert-manager.v1.10.1
    wait: true
    wait_condition:
      type: CatalogSourcesUnhealthy
      status: false
  vars:
    key: "{{ 'operators.coreos.com/cert-manager.' + operators_namespace }}"
    labels: "{{ [{'key': key, 'value': '' }] | items2dict }}"
  register: _result

- name: Wait for cert-manager
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Deployment
    name: cert-manager
    namespace: "{{ operators_namespace }}"
    wait: true
    wait_condition:
      type: Available
    wait_sleep: 20
    wait_timeout: 300
  register: _result
