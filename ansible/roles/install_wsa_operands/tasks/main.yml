---

- name: Create WebSphereAutomation instance
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: automation.websphere.ibm.com/v1
    kind: WebSphereAutomation
    name: wsa
    namespace: "{{ target_namespace }}"
    definition:
      spec:
        commonServices:
          registryNamespace: "{{ registry_namespace }}"
        license:
          accept: true
        replicas: 1
  register: _result
  when: install_individual_wsa_operands | default(false)

- name: Create WebSphereSecure instance
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: automation.websphere.ibm.com/v1
    kind: WebSphereSecure
    name: wsa-secure
    namespace: "{{ target_namespace }}"
    definition:
      spec:
        license:
          accept: true
        replicas: 1
      # {% if airgap_install | bool == true or http_proxy | bool == true %}    
      #  cveMonitor:
      # {% if airgap_install | bool == true %}    
      #     suspend: true
      # {% endif %}
      # {% if http_proxy | bool == true %}   
      #     env:
      #     - name: JVM_ARGS
      #       valueFrom:
      #         secretKeyRef:
      #           key: JVM_ARGS
      #           name: wsa-custom-ca-cert
      # {% endif %}
    wait: "{{ wait_for_wsa_operands | default(true) }}"
    wait_condition:
      type: Ready
    wait_sleep: 20
    wait_timeout: 1800
  register: _result
  when: (not install_healing) or (install_individual_wsa_operands | default(false))

- name: Create WebSphereHealth instance
  kubernetes.core.k8s:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: automation.websphere.ibm.com/v1
    kind: WebSphereHealth
    name: wsa-health
    namespace: "{{ target_namespace }}"
    definition:
      spec:
        license:
          accept: true
        replicas: 1
    wait: "{{ wait_for_wsa_operands | default(true) }}"
    wait_condition:
      type: Ready
    wait_sleep: 20
    wait_timeout: 1800
  register: _result
  when: install_healing

- name: Wait for WebSphereAutomation instance OperandRequestReady
  kubernetes.core.k8s_info:
    api_key: "{{ api_key | default(omit) }}"
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: automation.websphere.ibm.com/v1
    kind: WebSphereAutomation
    name: wsa
    namespace: "{{ target_namespace }}"
    wait: true
    wait_condition:
      type: OperandRequestReady
    wait_sleep: 40
    wait_timeout: 3600
  register: _result
