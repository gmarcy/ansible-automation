---

- import_playbook: ../plays/add_pull_secrets.yml
- import_playbook: ../plays/add_repository_mirror_config.yml

- name: Install CloudPak for Integration Catalog
  hosts: integration_platform
  gather_facts: false
  tags: integration_platform
  roles:
  - role: assert_default_storage_class
    api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
    kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
  - role: create_target_catalog_source
    api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
    kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
    target_catalog_source_name: "{{ cp4i_catalog_source_name }}"
    target_catalog_source_namespace: "{{ cp4i_catalog_source_namespace }}"
    target_catalog_source_display_name: "{{ cp4i_catalog_source_display_name }}"
    target_catalog_source_image: "{{ cp4i_catalog_source_image }}"
    target_catalog_source_image_tag: "{{ cp4i_catalog_source_image_tag }}"
    target_catalog_source_publisher: "{{ cp4i_catalog_source_publisher }}"
    target_catalog_source_poll_interval: "{{ cp4i_catalog_source_poll_interval }}"
  - role: create_target_namespace
    api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
    kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
    target_namespace: "{{ cp4i_namespace }}"
  - role: create_target_operator_group
    api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
    kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
    target_namespace: "{{ cp4i_namespace }}"
    target_operator_group: "{{ cp4i_operator_group }}"
    target_namespaces:
    - "{{ cp4i_namespace }}"
