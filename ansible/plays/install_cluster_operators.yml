---

- name: Install Cluster Operators
  hosts: cluster_operators
  gather_facts: false
  tags: cluster_operators
  tasks:
  - name: Create namespaces for the cluster operators
    include_role:
      name: create_target_namespace
    loop: "{{ operators_to_deploy | default([]) | map(attribute='namespace') | unique }}"
    loop_control:
      loop_var: target_namespace
    vars:
      api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
      kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
  - name: Create operator groups for the cluster operators
    include_role:
      name: create_target_operator_group
    loop: "{{ operators_to_deploy | default([]) | map(attribute='namespace') | unique }}"
    loop_control:
      loop_var: target_namespace
    vars:
      api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
      kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
      target_operator_group: "{{ target_namespace }}"
      target_namespaces: []
  - name: Create subscriptions for the cluster operators
    include_role:
      name: create_target_subscription
    loop: "{{ operators_to_deploy | default([]) }}"
    loop_control:
      loop_var: cluster_operator
    vars:
      api_key: "{{ hostvars['cluster-facts']['api_key'] | default(omit) }}"
      kubeconfig_path: "{{ hostvars['cluster-facts']['kubeconfig_path'] }}"
      target_operator_name: "{{ cluster_operator['name'] }}"
      target_operator_namespace: "{{ cluster_operator['namespace'] }}"
      target_operator_channel: "{{ cluster_operator['channel'] }}"
      target_catalog_source_name: "{{ cluster_operators_catalog_source_map[cluster_operator['catalog']]['name'] }}"
      target_catalog_source_namespace: "{{ cluster_operators_catalog_source_map[cluster_operator['catalog']]['namespace'] }}"
