---

- name: "Request a cluster from {{ hostvars['cluster-facts']['cluster_provisioner'] }}"
  hosts: "{{ hostvars['cluster-facts']['cluster_provisioner'] }}"
  gather_facts: false
  tasks:
  - name: "include_role: {{ provisioning_role }}"
    include_role:
      name: "{{ provisioning_role }}"

- name: Generate artifactory token when required
  hosts: playbook_secrets
  gather_facts: false
  pre_tasks:
  - name: Set need_artifactory_token fact
    set_fact:
      need_artifactory_token: "{{ artifactory_identity_token is defined and artifactory_token is not defined }}"
  roles:
  - role: generate_artifactory_token
    when: need_artifactory_token and artifactory_generate_access_token is defined

- name: Gather facts from all nodes
  hosts: all_nodes
  gather_facts: false
  roles:
  - role: setup_ansible_host
  - role: gather_host_facts
    gather_packages_info: false
    gather_services_info: false

- name: Setup services running in infra node
  hosts: infra_node
  gather_facts: false
  vars:
    deploy_infra_services: "{{ hostvars[groups[hostvars['cluster-facts']['cluster_provisioner']][0]]['deploy_infra_services'] }}"
  roles:
  - role: infra_enable_linger
    when: deploy_infra_services
  - role: infra_install_creds
    when: deploy_infra_services
  - role: infra_install_registry
    when: deploy_infra_services
  - role: infra_install_registry_proxy
    when: deploy_infra_services
  - role: infra_install_haproxy
    when: deploy_infra_services

- name: "Provision nodes using node_provisioning_role when requested"
  hosts: all_nodes
  gather_facts: false
  tasks:
  - name: "include_role: {{ node_provisioning_role | default('skipped') }}"
    include_role:
      name: "{{ node_provisioning_role }}"
    when: node_provisioning_role | default('') | length > 0
