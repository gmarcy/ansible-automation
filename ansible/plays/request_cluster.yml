---

- name: "Request a cluster from {{ hostvars['cluster-facts']['cluster_provisioner'] }}"
  hosts: "{{ hostvars['cluster-facts']['cluster_provisioner'] }}"
  gather_facts: false
  tasks:
  - name: "include_role: {{ provisioning_role }}"
    include_role:
      name: "{{ provisioning_role }}"

- name: "Provision nodes using node_provisioning_role when requested"
  hosts: all_nodes
  gather_facts: false
  roles:
  - role: setup_ansible_host
    ansible_ssh_user: "{{ hostvars['playbook-facts']['remote_user'] }}"
    remote_user: "{{ hostvars['playbook-facts']['remote_user'] }}"
  - role: gather_host_facts
    ansible_ssh_user: "{{ hostvars['playbook-facts']['remote_user'] }}"
    remote_user: "{{ hostvars['playbook-facts']['remote_user'] }}"
    gather_packages_info: false
    gather_services_info: false

- name: Setup services running in infra node
  hosts: infra_node
  gather_facts: false
  vars:
    deploy_infra_services: "{{ hostvars[groups[hostvars['cluster-facts']['cluster_provisioner']][0]]['deploy_infra_services'] }}"
  roles:
  - role: infra_enable_linger
    when: deploy_infra_services
  - role: infra_install_creds
    when: deploy_infra_services
  - role: infra_install_registry
    when: deploy_infra_services
  - role: infra_install_registry_proxy
    when: deploy_infra_services
  - role: infra_install_haproxy
    when: deploy_infra_services

- name: "Provision nodes using node_provisioning_role when requested"
  hosts: all_nodes
  gather_facts: false
  tasks:
  - name: "include_role: {{ node_provisioning_role | default('skipped') }}"
    include_role:
      name: "{{ node_provisioning_role }}"
    when: node_provisioning_role | default('') | length > 0
